rules:
  - id: auth_check_pattern
    message: "Compliance Violation: Route found without proper Auth dependency (Function or Router level)."
    languages: [python]
    severity: ERROR
    # --- Original Semgrep pattern logic ---
    patterns:
      - pattern: |
          @router.$METHOD(...)
          async def $FUNC(...):
              ...
      - pattern-not: |
          @router.$METHOD(...)
          async def $FUNC(..., $VAR=Depends(...), ...):
              ...
      - pattern-not: |
          @router.$METHOD(...)
          async def $FUNC(..., $VAR: $TYPE=Depends(...), ...):
              ...
      - pattern-not-inside: |
          $R = APIRouter(..., dependencies=[Depends($ANY)], ...)
              ...
    paths:
      exclude:
        - "**/backend/app/api/auth_ep.py" # **/ exclude file regardless of where the backend folder sits, unlike / where exclusion only applies to that specific location
  
  - id: admin_privilege_pattern
    message: "Privileged Access Violation: Admin endpoint must use 'require_admin' lock."
    languages: [python]
    severity: ERROR
    paths:
      include: ["**/backend/app/api/admin_ep.py"]
    patterns:
      - pattern-either:
          # Verify the Router itself has the admin lock
          - patterns:
              - pattern: "APIRouter(...)"
              - pattern-not: "APIRouter(..., dependencies=[Depends(require_admin)], ...)"
          # OR Verify individual functions don't use a weaker auth
          - patterns:
              - pattern: "Depends($AUTH)"
              - metavariable-regex:
                  metavariable: $AUTH
                  regex: "^(get_current_user|get_user)$" # Flags if standard user auth is used in admin file
# Add more patterns as needed